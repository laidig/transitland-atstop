angular.module("atstop.about.controller",["configuration","filters"]).controller("AboutCtrl",["$log","$cordovaAppVersion","$rootScope","$scope","$ionicScrollDelegate","PRIV_POLICY_TEXT","SHOW_BRANDING","BRAND_ABOUT_TEXT",function(o,t,e,r,a,i,n,l){r.data={version:"1.2.0",showBranding:n,hideText:!0,brandAboutText:l,privText:i},r.toggleText=function(){a.resize(),r.data.hideText=!r.data.hideText}}]);
angular.module("atstop",["atstop.about.controller","atstop.atstop.controller","atstop.favorites.controller","atstop.gohome.controller","atstop.nearby.controller","atstop.search.controller","atstop.atstop.service","atstop.datetime.service","atstop.favorites.service","atstop.geolocation.service","atstop.search.service","atstop.searchHistory.service","atstop.directives","leaflet-directive","ionic","ngCordova","angular-cache","angular-inview","timer"]).value("httpTimeout",1e4).constant("$ionicLoadingConfig",{template:"<ion-spinner></ion-spinner>",showBackdrop:!1}).run(["$ionicPlatform","$log",function(t,e){t.ready(function(){e.debug("yo yo"),$cordovaSplashscreen.hide(),navigator.splashscreen.hide(),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}]).run(["$http","CacheFactory",function(t,e){e.get("dataCache")||(t.defaults.cache=e("dataCache",{maxAge:9e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive"}))}]).run(["$rootScope","$ionicHistory","$ionicLoading","$ionicPopup","$cordovaNetwork","$timeout",function(t,e,o,a,r,s){t.$on("loading:show",function(){o.show()}),t.$on("loading:hide",function(){o.hide()}),t.$on("requestRejection",function(t,e){o.hide()})}]).config(["$httpProvider","$ionicConfigProvider",function(t,e){e.views.swipeBackEnabled(!1),e.tabs.position("bottom"),ionic.Platform.isAndroid()&&e.views.transition("none"),t.interceptors.push(["$rootScope",function(t){return{request:function(e){return t.$broadcast("loading:show"),e},requestError:function(e){return t.$broadcast("requestRejection",e),e},response:function(e){return t.$broadcast("loading:hide"),e},responseError:function(e){return t.$broadcast("requestRejection",e),e}}}])}]).config(["$logProvider",function(t){var e=ionic.Platform.platform();"macintel"===e||"linux"===e?t.debugEnabled(!0):t.debugEnabled(!1)}]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.home",{url:"/home",cache:!1,views:{"tab-home":{templateUrl:"templates/tab-home.html",controller:"SearchCtrl"}}}).state("tab.geolocation",{url:"/geolocation/:latitude/:longitude/:address",cache:!1,views:{"tab-home":{templateUrl:"templates/tab-nearby-stops-and-routes.html",controller:"NearbyStopsAndRoutesCtrl"}}}).state("tab.atstop",{url:"/atstop/:stopId/:stopName",cache:!1,views:{"tab-home":{templateUrl:"templates/atstop.html",controller:"AtStopCtrl"}}}).state("tab.about",{url:"/about",views:{"tab-home":{templateUrl:"templates/about.html",controller:"AboutCtrl"}}}).state("tab.favorites",{url:"/favorites",cache:!1,views:{"tab-favorites":{templateUrl:"templates/tab-favorites.html",controller:"FavoritesCtrl"}}}).state("tab.map-favorites",{url:"/map-favorites/:routeId/:routeName/:stopId",cache:!1,views:{"tab-favorites":{templateUrl:"templates/map.html",controller:"MapCtrl"}}}).state("tab.nearby-stops-and-routes",{url:"/nearby-stops-and-routes",cache:!1,views:{"tab-nearby-stops-and-routes":{templateUrl:"templates/tab-nearby-stops-and-routes.html",controller:"NearbyStopsAndRoutesCtrl"}}}).state("tab.map-gps",{url:"/map-gps/:routeId/:routeName/:stopId",cache:!1,views:{"tab-nearby-stops-and-routes":{templateUrl:"templates/map.html",controller:"MapCtrl"}}}),e.otherwise("/tab/home")}]);
angular.module("atstop.atstop.controller",["configuration","filters"]).controller("AtStopCtrl",["$log","$ionicScrollDelegate","$scope","AtStopService","$stateParams","$q","$ionicLoading","FavoritesService","$timeout","$filter","datetimeService","$interval","$location",function(t,a,e,o,s,i,r,n,l,d,p,c,f){e.data={link:"map",alerts:"",responseTime:"",loaded:!1,favClass:"",results:[],stopName:s.stopName,notifications:"",alertsHide:!1,alertsToggle:!1,stopId:s.stopId,tips:"Pull down for instant refresh."},e.toggleFavorites=function(){n.inFavorites(e.data.stopId)?(n.remove(e.data.stopId),e.data.favClass=""):(n.add(e.data.stopId,e.data.stopName),e.data.favClass="button-energized")};var u=function(){var a=i.defer();o.getBuses(e.data.stopId).then(function(o){angular.equals({},o.arriving)?(e.data.results="",e.data.notifications="We do not list any trips departing soon."):(e.data.responseTime=d("date")(o.responseTimestamp,"shortTime"),e.data.results=o.arriving,e.data.notifications=""),o.alerts.length>0?(e.data.alertsHide=!0,e.data.alerts=o.alerts,t.debug(e.data.alerts)):e.data.alertsHide=!1,a.resolve()}),a.promise.then(function(){e.data.loaded=!0})};e.refresh=function(){c.cancel(e.reloadTimeout),u(),e.reloadTimeout=c(u,35e3),e.$broadcast("scroll.refreshComplete")},e.toggleAlerts=function(){e.data.alertsToggle=!e.data.alertsToggle,a.resize()},e.$on("$destroy",function(){e.reloadTimeout&&c.cancel(e.reloadTimeout)});(function(){f.$$path.indexOf("atstop-favorites")>-1?e.data.link="map-favorites":f.$$path.indexOf("atstop-gps")>-1&&(e.data.link="map-gps"),n.inFavorites(e.data.stopId)?e.data.favClass="button-energized":e.data.favClass="",u(),e.reloadTimeout=c(u,35e3)})()}]);
angular.module("atstop.atstop.service",["ionic","configuration"]).factory("AtStopService",["$log","$q","$http","$filter","httpTimeout","CacheFactory","datetimeService","API_END_POINT","TRANSITLAND_KEY",function(e,r,t,a,n,o,i,s,c){o.get("atStopCache")||o("atStopCache",{maxAge:9e4,cacheFlushInterval:36e5,deleteOnExpire:"aggressive"});var p=function(a){var p;p=a.hasOwnProperty("stop")?a.stop:a,a.hasOwnProperty("sort")?sort=a.sort:sort=!0;var u=r.defer(),g={arriving:{},alerts:"",responseTimestamp:"",stopId:p},l={api_key:c,date:i.getDate(),origin_departure_between:i.getNextHalfHour(),origin_onestop_id:p,active:"true"};a.hasOwnProperty("line")&&(l.LineRef=a.line);var h=function(e){angular.forEach(e,function(e,r){angular.forEach(e.distances,function(e,r){e.arrivingIn=i.getRemainingTime(e.expectedArrivalTime)})})},f=t.get(s+"schedule_stop_pairs",{params:l,timeout:n,cache:o.get("atStopCache")}).success(function(e,r,t,a){if(g.responseTimestamp=moment().format(),e.schedule_stop_pairs.length>0){var n=[],o=[],i={};angular.forEach(e.schedule_stop_pairs,function(e,r){var t=e.route_onestop_id,a=t.split("-"),o=a[a.length-1].toUpperCase();n.push({routeId:t,name:o,distance:"",destination:e.trip_headsign,progress:"normalProgress",expectedArrivalTime:e.origin_arrival_time})}),o=_.groupBy(n,"routeId"),angular.forEach(o,function(e,r){var t=_.groupBy(e,"name");angular.forEach(t,function(e,t){i[r]={name:t,distances:e}})}),g.arriving=i,h(g.arriving)}}).error(function(r,t,a,n){e.debug("error")});return f.then(function(){u.resolve(g)}),u.promise};return{getBuses:p}}]);
angular.module("configuration",[]).constant("MAP_TILES","http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png").constant("MAP_ATTRS",'Map:<a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data:<a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.').constant("API_END_POINT","https://transit.land/api/v1/").constant("SEARCH_END_POINT","https://search.mapzen.com/v1/").constant("SEARCH_API_KEY","search-VDAAm8r").constant("TRANSITLAND_KEY","transitland-gyE87Ux").constant("MAPBOX_KEY","").constant("SHOW_BRANDING",!1).constant("PRIV_POLICY_TEXT","").constant("BRAND_ABOUT_TEXT","This is an example app for the transit.land API").constant("exampleSearches",{exampleRoutes:[],exampleStops:[],exampleIntersections:[]});
angular.module("atstop.datetime.service",["ionic","configuration"]).factory("datetimeService",["$log","$timeout",function(t,e){function o(t){var e,o=moment().utc();return e=t.length<8?moment(t)-o:moment(t,"HH:mm:ss")-o,0>e&&(e=0),e}function n(){return moment().format("YYYY-MM-DD")}function r(){return hhstart=moment().format("HH:mm"),hhend=moment().add(30,"m").format("HH:mm"),hh=hhstart+","+hhend,hh}var m=function(t){var e=Math.floor(t/864e5),o=t-864e5*e,n=Math.floor(o/36e5);o-=36e5*n;var r=Math.floor(o/6e4);o-=6e4*r;var m=Math.floor(o/1e3);return{days:e,hours:n,minutes:r,seconds:m}};return{duration:m,getRemainingTime:o,getDate:n,getNextHalfHour:r}}]);
angular.module("atstop.directives",[]).directive("ngTips",["$timeout","$rootScope",function(t,e){return e.tipCt=0,{restrict:"E",replace:!0,scope:{ngModel:"="},template:'<div class="tips">{{ngModel}}</div>',link:function(i,n,o){if(e.tipCt=++e.tipCt,i.$root.tipCt<3){var r=t(function(){n.remove()},3e3);i.$on("$destroy",function(){t.cancel(r)})}else n.remove()}}}]).directive("appHeader",function(){return{restrict:"E",scope:{},template:'<div style="padding-bottom: -100%; position: relative; text-align: center"><img src="img/logo.svg" style="width: 90%; height: auto;"> </div>'}}).directive("ngEnter",function(){return function(t,e,i){e.bind("keydown keypress",function(e){13===e.which&&(t.$apply(function(){t.$eval(i.ngEnter)}),e.preventDefault())})}});
angular.module("atstop.favorites.controller",["configuration","filters"]).controller("FavoritesCtrl",["$log","$scope","$ionicLoading","FavoritesService","$q","SHOW_BRANDING",function(a,t,o,e,n,i){t.data={loaded:!1,notifications:"",showBranding:i},t.remove=function(a){e.remove(a),r()};var r=function(){t.data.favoriteRoutes=[],t.data.favoriteStops=[],t.data.favoriteRouteMaps=[];var a=n.defer();e.get().then(function(o){0===Object.keys(o).length?t.data.notifications="You have not added any favorites. You can add favorites by clicking the star icon on routes, favorites, or maps.":angular.isUndefined(o)||null===o||(angular.forEach(o,function(a){"R"===a.type?t.data.favoriteRoutes.push(a):"RM"===a.type?t.data.favoriteRouteMaps.push(a):t.data.favoriteStops.push(a)}),t.data.notifications=""),a.resolve()}),a.promise.then(function(){t.data.loaded=!0})};(function(){r()})()}]);
angular.module("atstop.favorites.service",["ionic","configuration"]).factory("FavoritesService",["$log","$q","$window",function(e,r,a){var t=function(e,r,t){t=t||"S";var o=JSON.parse(a.localStorage.favorites||"{}"),i=e.replace("MAP","");o[e]={id:i,name:r,type:t},a.localStorage.setItem("favorites",JSON.stringify(o))},o=function(e){var r=JSON.parse(a.localStorage.favorites||"{}");delete r[e],a.localStorage.setItem("favorites",JSON.stringify(r))},i=function(){var e=r.defer();return e.resolve(JSON.parse(a.localStorage.getItem("favorites")||"{}")),e.promise},n=function(e){e=e||"";var r=JSON.parse(a.localStorage.favorites||"{}");return!(angular.isUndefined(r[e])||null===r[e])};return{add:t,remove:o,get:i,inFavorites:n}}]);
angular.module("filters",[]).filter("hrefToJS",["$sce","$sanitize",function(n,r){return function(e){return n.trustAsHtml(r(e).replace(/href="([\S]+)"/g,"onClick=\"window.open('$1', '_system', 'location=yes')\""))}}]).filter("isUndefinedOrEmpty",function(){return function(n){return angular.isUndefined(n)||null===n}}).filter("encodeStopName",function(){return function(n){return n=n||"",n=n.replace("/"," & "),n=n.replace("\\"," & ")}}).filter("alertsFilter",function(){return function(n){var r=Array.isArray(n)?n.join(" "):n,e=/^b\/d/i;return r=r.replace(e,"In Both Directions:"),e=/^s\/b/i,r=r.replace(e,"Southbound:"),e=/^n\/b/i,r=r.replace(e,"Northbound:")}}).filter("durationView",["$log","datetimeService",function(n,r){return function(n){var e=r.duration(n),t=e.minutes,i="";return e.hours>0&&e.hours<2&&(t+=60*e.hours),i=e.minutes>0?t+" min":""}}]);
angular.module("atstop.geolocation.service",["ionic","configuration"]).factory("GeolocationService",["$log","$q","$http","httpTimeout","API_END_POINT",function(o,t,e,n,r){var a=function(a,i){var c=t.defer(),s=[],u=e.get(r+"stops",{params:{lat:a,lon:i,r:200},cache:!0,timeout:n}).success(function(o,t,e,n){angular.forEach(o.stops,function(o){var t={};t.lat=o.geometry.coordinates[1],t.lon=o.geometry.coordinates[0],t.id=o.onestop_id,t.name=o.name,s.push(t)})}).error(function(t,e,n,r){o.debug("error")});return u.then(function(){c.resolve(s)}),c.promise};return{getStops:a}}]);
angular.module("atstop.gohome.controller",["configuration"]).controller("GoHomeCtrl",["$scope","$rootScope","$state","$ionicHistory",function(o,t,n,e){var i=function(){e.clearHistory(),e.nextViewOptions({historyRoot:!0})};o.goHomeTab=function(){i(),n.go("tab.home")},o.goFavsTab=function(){i(),n.go("tab.favorites")}}]);
angular.module("atstop.localstorage.service",["ionic","configuration"]).factory("$localstorage",["$log","$window",function(o,t){return{set:function(o,e){t.localStorage[o]=e},get:function(o,e){return t.localStorage[o]||e},setObject:function(o,e){t.localStorage[o]=JSON.stringify(e)},getObject:function(o){return JSON.parse(t.localStorage[o]||"{}")}}}]);
angular.module("atstop.nearby.controller",["configuration","filters"]).controller("NearbyStopsAndRoutesCtrl",["$log","$ionicLoading","$stateParams","$window","$location","$scope","GeolocationService","AtStopService","$q","$ionicPopup","$cordovaGeolocation","$filter","leafletData","$ionicScrollDelegate","$timeout","$interval","MAPBOX_KEY","MAP_TILES","MAP_ATTRS",function(t,e,n,o,a,i,r,l,s,c,u,f,p,d,h,g,m,v,b){i.markers={},i.paths={},i.url="atstop",i.left=!1,i.center={},i.data={inRouteView:!1,title:"Nearby Stops",loaded:!0,showMap:!0,stops:[],routes:[],markers:{},lat:"",lon:"",notifications:"",val:!1,showRoutes:!1,showStops:!0,results:[],mapHeight:Math.floor(document.getElementsByTagName("html")[0].clientHeight/2)-90,listHeight:Math.floor(document.getElementsByTagName("html")[0].clientHeight/2),tips:"Pull the list to refresh",nearbyStops:[]};var M,$=[],S=15,y=function(){i.reloadTimeout&&g.cancel(i.reloadTimeout)},k=function(){i.reloadTimeout=g(function(){N()},6e4)},w=function(){y(),k()};i.back=function(){i.data.inRouteView=!1,w(),i.reinitialize()},i.toggleStopAlerts=function(t){t.showAlerts=!t.showAlerts},i.reinitialize=function(){i.data.notifications="",w(),"/tab/nearby-stops-and-routes"===a.$$path?T():P(i.lat,i.lon),N(),i.$broadcast("scroll.refreshComplete")},i.lineInView=function(t,e,n,o){if(e===!0){var a=$.some(function(t){return t===o.inViewTarget.id});a||($.push(o.inViewTarget.id),N())}return!1};var N=function(){var t={},e={},n=[],o=(s.defer(),0),a=1e3;angular.forEach($,function(e){var i=o*a*Math.random();n.push(h(function(){console.log("delay "+i)},i).then(l.getBuses(e).then(function(n){angular.equals({},n.arriving)||(t[e]=n.arriving)}))),o++}),s.all(n).then(function(){angular.forEach(i.data.stops,function(n){n.arriving=t[n.id],n.alerts=e[n.id],n.loaded=!0,n.showAlerts=!1})}),i.$$phase||i.$apply()},P=function(t,e,n){void 0===n&&(n=!0),r.getStops(t,e).then(function(o){!angular.isUndefined(o)&&null!==o&&o.length>0?($=[],angular.forEach(o,function(n){n.dist=D(t,e,n.lat,n.lon)}),i.data.stops=o,n&&i.data.stops.push({id:"current_location",lat:t,lon:e}),C(),i.data.notifications="",h(function(){d.scrollTop()})):i.data.notifications="No nearby stops found."})},T=function(){i.loading=!0;var n=1e4,o=h(function(){if(i.data.notifications="Pull to refresh.",i.loading=!1,i.left!==!0){var e=c.alert({content:"Cannot access your position. Check if location services are enabled."});h(function(){e.close()},3e3)}else t.debug("You left the current page! Destroying ...")},n+5e3);u.getCurrentPosition({enableHighAccuracy:!1,timeout:n,maximumAge:0}).then(function(e){t.debug(e),i.loading=!1,h.cancel(o),i.data.notifications="",i.data.val=!0,P(e.coords.latitude,e.coords.longitude)},function(n){if(t.debug(n),i.data.notifications="Pull to refresh.",e.hide(),h.cancel(o),i.left!==!0){var a=c.alert({content:"Cannot access your position. Check if location is enabled."});h(function(){a.close()},3e3)}else t.debug("You left the current page! Destroying ...")})["finally"](function(){i.data.notifications="Pull to refresh.",i.loading=!1,h.cancel(o)})},C=function(){i.markers={},i.paths={},p.getMap().then(function(t){t.closePopup()});var t=[];angular.forEach(i.data.stops,function(e,n){"current_location"!=e.id?t["s"+n]={lat:e.lat,lng:e.lon,stopId:e.id,stopName:f("encodeStopName")(e.name),icon:{iconUrl:"img/stop_icons/stop.svg",iconSize:[20,20]},focus:!1}:t.currentLocation={lat:parseFloat(e.lat),lng:parseFloat(e.lon),stopId:e.currentLocation,stopName:"Current Location",icon:{iconUrl:"img/stop_icons/stop-blue.svg",iconSize:[20,20]},focus:!1,clickable:!1}}),i.markers=t,p.getMap().then(function(t){E().then(function(e){var n=S>=e||angular.isUndefined(e)?S:e;17>n&&t.setView(i.markers.s0,n,{animate:!0})})})},z=function(){angular.extend(i,{events:{markers:{enable:["click","dragend","zoomstart","zoomend"],logic:"emit"}},center:i.center,defaults:{tileLayer:v,tileLayerOptions:{attribution:f("hrefToJS")(b)},scrollWheelZoom:!0,key:m,zoomControl:!1},options:{reuseTiles:!0},markers:{},paths:{}}),p.getMap().then(function(t){t.attributionControl.setPrefix("")})};i.showRoutePolylines=function(t){i.paths={}};var A=function(t){p.getMap().then(function(t){t.closePopup()})};i.showCurrentStop=function(t,e,n,o,a){i.data.inRouteView=!0,g.cancel(i.reloadTimeout),I(t,e,n,o,a),i.reloadTimeout=g(function(){I(t,e,n,o,a)},35e3)};var I=function(t,e,n,o,a){i.markers={},p.getMap().then(function(t){t.closePopup()}),i.markers.currentStop={lat:n,lng:o,icon:{iconUrl:"img/stop_icons/stop-blue.svg",iconSize:[20,20]},focus:!1,stopId:e,stopName:f("encodeStopName")(a)},p.getMap().then(function(t){t.closePopup(),t.setView(i.markers.currentStop,13,{animate:!0})}),A(t)},V=function(t){t=a.hash(t),h(function(){d.anchorScroll("#"+t)})},E=function(e){var n,o=s.defer();return p.getMap().then(function(e){mapZoom=e._zoom,U(mapZoom)?n=mapZoom:(t.debug("using default zoom"),n=S),o.resolve(n)}),o.promise},_=function(t,e){i.data.inRouteView||p.getMap().then(function(t){var e=t.getCenter().lat,n=t.getCenter().lng;ionic.debounce(P(e,n,!1),500),i.lat=e,i.lon=n})};i.$on("leafletDirectiveMap.dragend",function(t,e){E().then(function(n){n>=S&&_(t,e)})}),i.$on("leafletDirectiveMap.zoomend",function(t,e){E().then(function(n){n>=S&&n>M&&_(t,e)})}),i.$on("leafletDirectiveMap.zoomstart",function(t,e){E().then(function(t){M=t})}),i.$on("leafletDirectiveMarker.click",function(t,e){var n=i.markers[e.modelName],o="",a=L.popup();f("isUndefinedOrEmpty")(n.stopName)?o="Vehicle "+n.vehicleId+"<br> <h4>"+n.destination+"</h4><br> <h5>Next Stop: "+n.nextStop+"</h5>":"Current Location"===n.stopName?o="<p>Current Location</p>":(V(n.stopId),o="<p>"+n.stopName+'</p><a href="#/tab/'+i.url+"/"+n.stopId+"/"+n.stopName+'" class="button button-clear button-full button-small">See upcoming buses</a>'),latLng=[n.lat,n.lng],a.setContent(o).setLatLng(latLng),p.getMap().then(function(t){a.openOn(t)})}),i.$on("$destroy",function(){i.left=!0,i.reloadTimeout&&g.cancel(i.reloadTimeout)});var D=function(t,e,n,o){var a=6371,i=R(n-t),r=R(o-e),l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(R(t))*Math.cos(R(n))*Math.sin(r/2)*Math.sin(r/2),s=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),c=a*s*1e3;return parseInt(c,10)},R=function(t){return t*(Math.PI/180)},U=function(t){if(isNaN(t))return!1;var e=parseFloat(t);return(0|e)===e};(function(){z(),"/tab/nearby-stops-and-routes"===a.$$path?(i.data.title="Nearby Stops",i.url="atstop-gps",T()):(i.data.title=n.address,P(n.latitude,n.longitude)),N(),k()})()}]);
angular.module("atstop.search.controller",["configuration","filters"]).controller("SearchCtrl",["$log","$rootScope","$scope","$location","SearchHistoryService","$filter","$ionicLoading","$ionicPopup","$ionicPlatform","SearchService","SHOW_BRANDING","$ionicTabsDelegate",function(e,t,a,o,i,s,c,n,r,d,h,u){a.go=function(e){console.log(e),o.path(e)},a.data={results:[],searchKey:"",notifications:"",exampleIntersections:["Estacion de Autobuses Poniente","Transamerica Pyramid","Roma Termini"],searches:[],showSearches:!0,showDefaultTips:!0,showBranding:h},a.autocomplete=function(){a.data.searchKey.length>0?d.autocomplete(a.data.searchKey).then(function(e){!angular.isUndefined(e)&&null!==e&&e.length>0?(a.data.results=e,a.data.notifications=""):(a.data.results=[],a.data.notifications="No matches")}):(a.data.results=[],a.data.notifications="")};var l=function(t){if(Object.keys(t.directions).length>1)t.directions[0].hasUpcomingScheduledService||t.directions[1].hasUpcomingScheduledService?(e.debug("service in both directions"),a.go("/tab/route/"+t.id+"/"+t.shortName)):t.directions[0].hasUpcomingScheduledService||t.directions[1].hasUpcomingScheduledService?e.debug("service?"):(e.debug("no service in both directions"),g(t.shortName));else{e.debug("1D 4eva!");var o=Object.keys(t.directions)[0];t.directions[o].hasUpcomingScheduledService?(e.debug("1direction with service"),a.go("/tab/route/"+t.id+"/"+t.shortName)):(e.debug("1direction with no service"),g(t.shortName))}},g=function(e){a.data.notifications="There is no scheduled service on this route at this time."};a.searchAndGo=function(t){1===a.data.results.length&&(t=a.data.results[0]),d.search(t).then(function(t){switch(i.add(t),t.type){case"RouteResult":l(t);break;case"StopResult":a.go("/tab/atstop/"+t.id+"/"+s("encodeStopName")(t.name));break;case"GeocodeResult":a.go("/tab/geolocation/"+t.latitude+"/"+t.longitude+"/"+t.formattedAddress);break;default:a.data.results=[],a.data.notifications="No matches",e.debug("undefined type")}})},a.clearSearches=function(){i.clear(),a.data.searches=[],a.data.showSearches=!1,a.data.showDefaultTips=!0};(function(){i.fetchAll().then(function(e){e.length>0?(a.data.searches=e,a.data.showSearches=!0,a.data.showDefaultTips=!1):(a.data.searches=[],a.data.showSearches=!1)})})()}]);
angular.module("atstop.search.service",["ionic","configuration"]).factory("SearchService",["$log","$q","$http","httpTimeout","SEARCH_END_POINT","SEARCH_API_KEY",function(e,t,r,a,o,c){var n=function(n){var u=t.defer(),s=[],i=r.get(o+"autocomplete",{params:{api_key:c,text:n},cache:!0,timeout:a}).success(function(e,t,r,a){var o=[];angular.forEach(e.features,function(e){o.push(e.properties.name)}),s=o}).error(function(t,r,a,o){e.debug("error")});return i.then(function(){u.resolve(s)}),u.promise},u=function(n){var u=t.defer(),s={},i=r.get(o+"search",{params:{api_key:c,text:n},cache:!0,timeout:a}).success(function(e,t,r,a){e.features.length>0&&(matchesData=e.features[0],s={type:"GeocodeResult",formattedAddress:matchesData.properties.label,latitude:matchesData.geometry.coordinates[1],longitude:matchesData.geometry.coordinates[0]})}).error(function(t,r,a,o){e.debug("error")});return i.then(function(){u.resolve(s)}),u.promise};return{autocomplete:n,search:u}}]);
angular.module("atstop.searchHistory.service",["ionic","configuration"]).factory("SearchHistoryService",["$log","$q","$window",function(e,r,t){var a=function(e,r,a){var o=Array.prototype.slice.call(JSON.parse(t.localStorage.searches||"[]"));o.length>0&&(angular.forEach(o,function(r,t){r.term==e&&o.splice(t,1)}),o.length>=5&&o.splice(0,1)),o.push({term:e,title:r,data:a}),t.localStorage.setItem("searches",JSON.stringify(o))},o=function(r){switch(r.type){case"RouteResult":a(r.id,r.shortName,r);break;case"StopResult":a(r.id,r.name,r);break;case"GeocodeResult":a(r.formattedAddress,r.formattedAddress,r);break;default:e.debug("undefined type")}},s=function(){var e=r.defer();return e.resolve(Array.prototype.slice.call(JSON.parse(t.localStorage.searches||"[]")).reverse()),e.promise},c=function(){t.localStorage.removeItem("searches")};return{add:o,fetchAll:s,clear:c}}]);